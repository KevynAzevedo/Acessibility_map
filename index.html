<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Help!</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS e JS para OpenStreetMap -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Routing Machine CSS e JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <!-- Font Awesome para ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Importa a fonte Inter do Google Fonts para uma tipografia moderna */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        /* Estilo para alto contraste (Daltonismo) */
        body.high-contrast {
            background-color: #000;
            color: #fff;
        }
        body.high-contrast .bg-white { background-color: #111; }
        body.high-contrast .text-gray-800 { color: #fff; }
        body.high-contrast .text-gray-600 { color: #ccc; }
        body.high-contrast button { border: 1px solid #fff; }
        body.high-contrast .bg-blue-600 { background-color: #ffc40e; color: #000; }
        body.high-contrast #destination-input {
            background-color: #222;
            color: #fff;
            border-color: #ffc40e;
        }
        body.high-contrast #destination-input::placeholder {
            color: #aaa;
        }
        
        .leaflet-routing-container { display: none; }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .poi-icon {
            color: #3B82F6;
            text-align: center;
        }
        body.high-contrast .poi-icon {
             color: #ffc40e;
        }
        
        #route-instructions-panel, #floating-buttons-container { z-index: 1000; }
        #poi-modal, #gemini-modal, #assistant-modal, #tutorial-modal { z-index: 2000; }

        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        body.high-contrast .loader {
            border-top: 4px solid #ffc40e;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Tela de Seleção de Perfil -->
    <div id="profile-form" class="fixed inset-0 bg-white z-50 p-6 flex items-center justify-center fade-in">
        <div class="w-full max-w-md">
            <h2 class="text-3xl font-bold text-gray-800 mb-2 text-center">Bem-vindo ao Help!</h2>
            <p class="text-gray-600 mb-6 text-center">Selecione as suas preferências para começar.</p>
            <div class="space-y-4">
                <div>
                    <label for="disability-type" class="block text-lg font-semibold text-gray-700">Perfil de Acessibilidade:</label>
                    <select id="disability-type" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm text-lg">
                        <option value="none">Nenhum</option>
                        <option value="visual">Deficiência Visual (Narrador Ativado)</option>
                        <option value="motor">Deficiência Motora (Botões Maiores)</option>
                        <option value="daltonism">Daltonismo (Alto Contraste)</option>
                    </select>
                </div>
                <div class="flex items-center">
                    <input id="vibration-feedback" type="checkbox" class="h-5 w-5 text-blue-600 border-gray-300 rounded">
                    <label for="vibration-feedback" class="ml-2 block text-lg text-gray-800">Ativar feedback por vibração</label>
                </div>
            </div>
            <button id="start-btn" class="mt-8 w-full bg-blue-600 text-white text-xl font-bold py-4 rounded-lg shadow-md hover:bg-blue-700 transition">Começar a Navegar</button>
        </div>
    </div>

    <!-- Tela Principal de Navegação -->
    <div id="navigation-screen" class="hidden flex flex-col h-screen">
        <!-- Painel Superior (Busca e Controles) -->
        <div id="planning-panel" class="p-4 bg-white shadow-lg z-20 fade-in">
            <div class="flex items-center gap-2">
                <div class="relative flex-grow">
                    <i class="fa-solid fa-location-dot absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="destination-input" placeholder="Para onde vamos?" class="w-full p-3 pl-10 border rounded-lg">
                    <button id="voice-input-btn" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-blue-600"><i class="fa-solid fa-microphone"></i></button>
                </div>
                <button id="find-route-btn" class="bg-blue-600 text-white p-3 rounded-lg"><i class="fa-solid fa-magnifying-glass"></i></button>
            </div>
            <div id="suggestions-box" class="bg-white rounded-lg shadow-md mt-2"></div>
            <div id="mode-buttons" class="flex justify-around items-center mt-3 pt-2 border-t">
                <button data-mode="driving" class="transport-mode p-2 rounded-lg text-gray-600 hover:bg-gray-200" title="Carro"><i class="fa-solid fa-car fa-xl"></i></button>
                <button data-mode="walking" class="transport-mode p-2 rounded-lg text-gray-600 hover:bg-gray-200" title="A Pé"><i class="fa-solid fa-person-walking fa-xl"></i></button>
                <button data-mode="cycling" class="transport-mode p-2 rounded-lg text-gray-600 hover:bg-gray-200" title="Bicicleta"><i class="fa-solid fa-bicycle fa-xl"></i></button>
                <button data-mode="wheelchair" class="transport-mode p-2 rounded-lg text-gray-600 hover:bg-gray-200" title="Cadeira de Rodas"><i class="fa-solid fa-wheelchair fa-xl"></i></button>
            </div>
        </div>

        <div class="relative flex-grow">
            <div id="map" class="h-full w-full"></div>

            <!-- Painel de Instruções de Rota -->
            <div id="route-instructions-panel" class="hidden absolute bottom-0 left-0 right-0 p-4 bg-white shadow-[0_-2px_10px_rgba(0,0,0,0.1)] rounded-t-2xl fade-in">
                 <div class="flex justify-between items-center mb-3">
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">A sua Rota</h3>
                        <p id="route-eta" class="text-gray-600 font-semibold"></p> 
                    </div>
                    <button id="back-to-planning-btn" class="text-sm text-blue-600 font-semibold">Nova Rota</button>
                </div>
                <div id="current-instruction" class="text-center p-4 bg-gray-100 rounded-lg">
                    <p class="text-lg text-gray-800">A iniciar rota...</p>
                </div>
                <button id="next-step-btn" class="mt-3 w-full bg-blue-600 text-white font-bold py-3 rounded-lg">Próxima Etapa</button>
            </div>

            <!-- Botões Flutuantes de Controle do Mapa -->
            <div id="floating-buttons-container" class="absolute bottom-10 right-4 z-[1000] space-y-3">
                <button id="assistant-btn" class="w-14 h-14 bg-white rounded-full shadow-md text-blue-600 flex items-center justify-center" title="Assistente Virtual"><i class="fa-solid fa-headset fa-lg"></i></button>
                <button id="toggle-pois-btn" class="w-14 h-14 bg-white rounded-full shadow-md text-blue-600 flex items-center justify-center" title="Pontos de Interesse"><i class="fa-solid fa-landmark fa-lg"></i></button>
                <button id="describe-surroundings-btn" class="w-14 h-14 bg-white rounded-full shadow-md text-blue-600 flex items-center justify-center" title="Descrever Arredores (IA)"><i class="fa-solid fa-binoculars fa-lg"></i></button>
                <button id="center-user-btn" class="w-14 h-14 bg-white rounded-full shadow-md text-blue-600 flex items-center justify-center" title="Centralizar em mim"><i class="fa-solid fa-location-crosshairs fa-lg"></i></button>
            </div>
        </div>
    </div>
    
    <!-- Modal para Seleção de POIs -->
    <div id="poi-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm fade-in">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Pontos de Interesse</h3>
            <div class="space-y-3" id="poi-options">
                 <p class="font-semibold text-gray-700">Acessibilidade:</p>
                 <div class="flex items-center"><input type="checkbox" id="poi-ramps" value="ramps" class="h-5 w-5"><label for="poi-ramps" class="ml-3 text-lg">Rampas de Acesso</label></div>
                 <div class="flex items-center"><input type="checkbox" id="poi-toilets" value="toilets" class="h-5 w-5"><label for="poi-toilets" class="ml-3 text-lg">Casas de Banho Acessíveis</label></div>
                 <div class="flex items-center"><input type="checkbox" id="poi-parking" value="parking" class="h-5 w-5"><label for="poi-parking" class="ml-3 text-lg">Estacionamento Acessível</label></div>
                 <hr class="my-3">
                 <p class="font-semibold text-gray-700">Geral:</p>
                 <div class="flex items-center"><input type="checkbox" id="poi-hospitals" value="hospitals" class="h-5 w-5"><label for="poi-hospitals" class="ml-3 text-lg">Hospitais</label></div>
                 <div class="flex items-center"><input type="checkbox" id="poi-bus-stops" value="bus_stops" class="h-5 w-5"><label for="poi-bus-stops" class="ml-3 text-lg">Paragens de Autocarro</label></div>
                 <div class="flex items-center"><input type="checkbox" id="poi-traffic-signals" value="traffic_signals" class="h-5 w-5"><label for="poi-traffic-signals" class="ml-3 text-lg">Semáforos</label></div>
                 <div class="flex items-center"><input type="checkbox" id="poi-restaurants" value="restaurants" class="h-5 w-5"><label for="poi-restaurants" class="ml-3 text-lg">Restaurantes</label></div>
            </div>
            <div class="mt-6 flex gap-3">
                <button id="close-poi-modal-btn" class="w-full py-2 bg-blue-600 text-white rounded-lg">Aplicar e Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal Gemini -->
    <div id="gemini-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-800">Descrição dos Arredores</h3>
                <button id="close-gemini-modal-btn" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="gemini-content" class="min-h-[150px] max-h-[60vh] overflow-y-auto">
                <div id="gemini-loader" class="flex justify-center items-center h-full">
                    <div class="loader"></div>
                </div>
                <p id="gemini-response" class="text-gray-700 whitespace-pre-wrap"></p>
            </div>
        </div>
    </div>

    <!-- Modal Assistente Virtual -->
    <div id="assistant-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md fade-in text-center">
            <div class="relative w-24 h-24 mx-auto mb-4">
                <div id="assistant-icon" class="w-full h-full rounded-full bg-blue-600 flex items-center justify-center transition-transform duration-300">
                    <i class="fa-solid fa-headset text-white text-4xl"></i>
                </div>
                <div id="listening-indicator" class="hidden absolute top-0 left-0 w-full h-full rounded-full border-4 border-blue-300 animate-ping"></div>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Assistente Virtual</h3>
            <p id="assistant-text" class="text-gray-700 text-lg min-h-[50px]"></p>
            <button id="close-assistant-modal-btn" class="mt-6 w-full py-2 bg-gray-200 rounded-lg">Fechar</button>
        </div>
    </div>

    <!-- Modal Tutorial -->
    <div id="tutorial-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg fade-in text-center">
            <div id="tutorial-content" class="min-h-[200px]">
                <!-- Conteúdo do tutorial será injetado aqui -->
            </div>
            <div class="flex justify-between items-center mt-6">
                <button id="tutorial-prev-btn" class="py-2 px-4 bg-gray-200 rounded-lg hover:bg-gray-300">Anterior</button>
                <p id="tutorial-step-indicator" class="text-gray-600 font-semibold"></p>
                <button id="tutorial-next-btn" class="py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Próximo</button>
            </div>
        </div>
    </div>


    <script>
        // Variáveis globais e de estado
        let mapa;
        let userMarker;
        let routingControl;
        let userLocation = null;
        let wakeWordRecognition;
        let state = {
            profile: 'none',
            vibrationEnabled: false,
            currentRouteMode: 'driving',
            currentStep: 0,
            routeInstructions: [],
            visiblePoiTypes: [],
            routeInitiatedByAssistant: false,
        };
        const poiLayers = {
            ramps: L.layerGroup(),
            toilets: L.layerGroup(),
            parking: L.layerGroup(),
            hospitals: L.layerGroup(),
            bus_stops: L.layerGroup(),
            traffic_signals: L.layerGroup(),
            restaurants: L.layerGroup(),
        };
        // Estado do Assistente Virtual
        let assistantState = {
            active: false,
            stage: 'idle', // 'idle', 'listening_destination', 'confirming_destination'
            tempAddress: null,
        };
        
        // Elementos da DOM
        const profileForm = document.getElementById('profile-form');
        const startBtn = document.getElementById('start-btn');
        const navigationScreen = document.getElementById('navigation-screen');
        const destinationInput = document.getElementById('destination-input');
        const suggestionsBox = document.getElementById('suggestions-box');
        const findRouteBtn = document.getElementById('find-route-btn');
        const modeButtons = document.querySelectorAll('.transport-mode');
        const planningPanel = document.getElementById('planning-panel');
        const instructionsPanel = document.getElementById('route-instructions-panel');
        const floatingButtonsContainer = document.getElementById('floating-buttons-container');
        const currentInstructionText = document.querySelector('#current-instruction p');
        const nextStepBtn = document.getElementById('next-step-btn');
        const backToPlanningBtn = document.getElementById('back-to-planning-btn');
        const centerUserBtn = document.getElementById('center-user-btn');
        const voiceInputBtn = document.getElementById('voice-input-btn');
        const togglePoisBtn = document.getElementById('toggle-pois-btn');
        const poiModal = document.getElementById('poi-modal');
        const closePoiModalBtn = document.getElementById('close-poi-modal-btn');
        const describeSurroundingsBtn = document.getElementById('describe-surroundings-btn');
        const geminiModal = document.getElementById('gemini-modal');
        const closeGeminiModalBtn = document.getElementById('close-gemini-modal-btn');
        const geminiLoader = document.getElementById('gemini-loader');
        const geminiResponseEl = document.getElementById('gemini-response');
        const assistantBtn = document.getElementById('assistant-btn');
        const assistantModal = document.getElementById('assistant-modal');
        const assistantText = document.getElementById('assistant-text');
        const listeningIndicator = document.getElementById('listening-indicator');
        const closeAssistantModalBtn = document.getElementById('close-assistant-modal-btn');
        // Elementos do Tutorial
        const tutorialModal = document.getElementById('tutorial-modal');
        const tutorialContent = document.getElementById('tutorial-content');
        const tutorialPrevBtn = document.getElementById('tutorial-prev-btn');
        const tutorialNextBtn = document.getElementById('tutorial-next-btn');
        const tutorialStepIndicator = document.getElementById('tutorial-step-indicator');
        
        // --- INICIALIZAÇÃO E PERFIL ---
        
        startBtn.addEventListener('click', () => {
            state.profile = document.getElementById('disability-type').value;
            state.vibrationEnabled = document.getElementById('vibration-feedback').checked;
            
            if (state.profile === 'daltonism') document.body.classList.add('high-contrast');
            if (state.profile === 'motor') document.body.classList.add('text-lg');

            profileForm.classList.add('hidden');
            navigationScreen.style.display = 'flex';
            initMap();
            showTutorial();
        });

        // --- MAPA E GEOLOCALIZAÇÃO ---

        function initMap() {
            mapa = L.map('map').setView([-23.45, -46.53], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
            }).addTo(mapa);
            
            mapa.locate({ setView: true, maxZoom: 16, watch: true });
            mapa.on('locationfound', onLocationFound);
            mapa.on('locationerror', onLocationError);

            const debouncedPoiFetcher = debounce(fetchAndDisplayPOIs, 1500);
            mapa.on('zoomend', debouncedPoiFetcher);
            mapa.on('moveend', debouncedPoiFetcher);
            startWakeWordListener(); // Inicia o listener da palavra-chave
        }

        function onLocationFound(e) {
            userLocation = e.latlng;
            const userIcon = L.divIcon({
                html: '<i class="fa-solid fa-circle text-blue-600 text-2xl"></i>',
                className: '',
                iconSize: [24, 24]
            });
            if (!userMarker) {
                userMarker = L.marker(e.latlng, { icon: userIcon }).addTo(mapa).bindPopup("Você está aqui!").openPopup();
            } else {
                userMarker.setLatLng(e.latlng);
            }
        }
        
        function onLocationError(e) {
            alert("Não foi possível obter a sua localização. Verifique as permissões do navegador.");
        }
        
        // --- ROTEAMENTO ---

        findRouteBtn.addEventListener('click', () => {
             if (suggestionsBox.firstChild) {
                 suggestionsBox.firstChild.click();
             }
        });

        async function fetchAddressSuggestions(query) {
            if (query.length < 3) {
                suggestionsBox.innerHTML = '';
                return null;
            }
            const viewbox = mapa.getBounds().toBBoxString();
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${query}&countrycodes=br&limit=5&viewbox=${viewbox}&bounded=1`;
            const response = await fetch(url);
            const data = await response.json();
            
            if (assistantState.active) {
                return data;
            }

            suggestionsBox.innerHTML = '';
            data.forEach(item => {
                const div = document.createElement('div');
                div.innerHTML = item.display_name;
                div.className = 'p-3 border-b cursor-pointer hover:bg-gray-100';
                div.onclick = () => createRoute(item.lat, item.lon, item.display_name);
                suggestionsBox.appendChild(div);
            });
            return null;
        }
        
        function createRoute(lat, lon, name) {
            if (!userLocation) {
                alert("A aguardar a sua localização...");
                return;
            }
            destinationInput.value = name;
            suggestionsBox.innerHTML = '';

            const destCoords = L.latLng(lat, lon);
            
            let osrmProfile = 'driving';
            if (state.currentRouteMode === 'walking' || state.currentRouteMode === 'wheelchair') osrmProfile = 'foot';
            else if (state.currentRouteMode === 'cycling') osrmProfile = 'bike';

            if(routingControl) mapa.removeControl(routingControl);

            routingControl = L.Routing.control({
                waypoints: [userLocation, destCoords],
                routeWhileDragging: true,
                router: L.Routing.osrmv1({ serviceUrl: `https://router.project-osrm.org/route/v1`, profile: osrmProfile }),
                createMarker: function(i, wp, n) {
                    if (i === n - 1) { 
                         return L.marker(wp.latLng, {
                            icon: L.divIcon({
                                html: '<i class="fa-solid fa-location-pin text-red-500 text-4xl"></i>',
                                className: '',
                                iconAnchor: [12, 40]
                            })
                        });
                    }
                    return null;
                }
            }).addTo(mapa);

            routingControl.on('routesfound', function(e) {
                const route = e.routes[0];
                state.routeInstructions = route.instructions;
                const totalTime = route.summary.totalTime;
                document.getElementById('route-eta').textContent = formatTime(totalTime);
                state.currentStep = 0;
                displayInstruction();
                switchToNavigationMode();
                if(state.vibrationEnabled) navigator.vibrate(200);
            });
        }
        
        modeButtons.forEach(button => {
            button.addEventListener('click', () => {
                modeButtons.forEach(btn => btn.classList.remove('bg-blue-600', 'text-white'));
                button.classList.add('bg-blue-600', 'text-white');
                state.currentRouteMode = button.dataset.mode;
            });
        });

        // --- NAVEGAÇÃO PASSO A PASSO ---

        function displayInstruction() {
            if (state.currentStep < state.routeInstructions.length) {
                const instruction = state.routeInstructions[state.currentStep];
                const text = `${instruction.text} (${Math.round(instruction.distance)}m)`;
                currentInstructionText.textContent = text;
                if (state.profile === 'visual' || state.routeInitiatedByAssistant) speak(text);
            } else {
                const arrivalText = "Você chegou ao seu destino!";
                currentInstructionText.textContent = arrivalText;
                if (state.profile === 'visual' || state.routeInitiatedByAssistant) speak(arrivalText);
            }
        }
        
        function nextStep() {
            if (state.currentStep < state.routeInstructions.length - 1) {
                state.currentStep++;
                displayInstruction();
                if(state.vibrationEnabled) navigator.vibrate(100);
            }
        }
        nextStepBtn.addEventListener('click', nextStep);

        // --- CONTROLE DE UI ---

        function switchToNavigationMode() {
            planningPanel.style.display = 'none';
            instructionsPanel.classList.remove('hidden');
            floatingButtonsContainer.classList.add('hidden');
        }

        function switchToPlanningMode() {
            if (routingControl) mapa.removeControl(routingControl);
            instructionsPanel.classList.add('hidden');
            planningPanel.style.display = 'block';
            floatingButtonsContainer.classList.remove('hidden');
            destinationInput.value = '';
            Object.values(poiLayers).forEach(layer => layer.clearLayers());
            state.routeInitiatedByAssistant = false;
        }
        backToPlanningBtn.addEventListener('click', switchToPlanningMode);
        
        centerUserBtn.addEventListener('click', () => {
            if (userLocation) mapa.setView(userLocation, 16);
        });
        
        // --- POIs DE ACESSIBILIDADE E GERAIS ---

        togglePoisBtn.addEventListener('click', () => poiModal.classList.remove('hidden'));
        
        closePoiModalBtn.addEventListener('click', () => {
            const poiOptions = document.querySelectorAll('#poi-options input:checked');
            state.visiblePoiTypes = Array.from(poiOptions).map(input => input.value);
            poiModal.classList.add('hidden');
            fetchAndDisplayPOIs();
        });

        const poiQueries = {
            ramps: 'node["kerb"="lowered"]',
            toilets: 'node["amenity"="toilets"]["wheelchair"="yes"]',
            parking: 'node["amenity"="parking"]["wheelchair"="yes"]',
            hospitals: 'node["amenity"="hospital"]',
            bus_stops: 'node["highway"="bus_stop"]',
            traffic_signals: 'node["highway"="traffic_signals"]',
            restaurants: 'node["amenity"="restaurant"]',
        };

        const poiIcons = {
            ramps: { icon: 'fa-wheelchair', text: 'Rampa de Acesso' },
            toilets: { icon: 'fa-restroom', text: 'Casa de Banho Acessível' },
            parking: { icon: 'fa-square-parking', text: 'Estacionamento Acessível' },
            hospitals: { icon: 'fa-hospital', text: 'Hospital' },
            bus_stops: { icon: 'fa-bus-simple', text: 'Paragem de Autocarro' },
            traffic_signals: { icon: 'fa-traffic-light', text: 'Semáforo' },
            restaurants: { icon: 'fa-utensils', text: 'Restaurante' },
        };
        
        async function fetchAndDisplayPOIs() {
            const zoom = mapa.getZoom();
            const typesToFetch = state.visiblePoiTypes.filter(type => {
                if (type === 'hospitals') return zoom >= 14;
                if (type === 'restaurants' || type === 'bus_stops') return zoom >= 15;
                if (['traffic_signals', 'ramps', 'toilets', 'parking'].includes(type)) return zoom >= 17;
                return false;
            });

            Object.keys(poiLayers).forEach(type => {
                if (!typesToFetch.includes(type)) poiLayers[type].clearLayers();
            });

            if (typesToFetch.length === 0) return;

            const bounds = mapa.getBounds().toBBoxString();
            let query = `[out:json];(`;
            typesToFetch.forEach(poiType => {
                if (poiQueries[poiType]) query += `${poiQueries[poiType]}(${bounds});`;
            });
            query += `);out;`;
            
            try {
                const response = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`);
                if(!response.ok) return;
                const data = await response.json();
                
                typesToFetch.forEach(type => poiLayers[type].clearLayers());
            
                data.elements.forEach(el => {
                    let poiType = typesToFetch.find(key => {
                        if(!el.tags) return false;
                        const tag = poiQueries[key].match(/\["(.+?)"/)[1];
                        const value = poiQueries[key].match(/="(.+?)"/)[1];
                        return el.tags[tag] === value;
                    });

                    if (poiType && poiIcons[poiType]) {
                        const { icon, text } = poiIcons[poiType];
                        const markerIcon = L.divIcon({
                            html: `<i class="fa-solid ${icon} poi-icon text-2xl"></i>`,
                            className: '', iconSize: [24, 24], iconAnchor: [12, 12]
                        });
                        L.marker([el.lat, el.lon], { icon: markerIcon }).addTo(poiLayers[poiType]).bindPopup(el.tags.name || text);
                    }
                });
            } catch (error) {
                console.error("Erro ao buscar POIs:", error);
            }
        }
        
        // --- SÍNTESE DE FALA E RECONHECIMENTO DE VOZ ---

        function speak(text, callback) {
            if (!('speechSynthesis' in window)) {
                if(callback) callback();
                return;
            };
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'pt-PT';
            utterance.onend = callback;
            window.speechSynthesis.speak(utterance);
        }

        function startVoiceRecognition(callback) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert("O reconhecimento de voz não é suportado neste navegador.");
                return null;
            }
            const recognition = new SpeechRecognition();
            recognition.lang = 'pt-PT';
            
            listeningIndicator.classList.remove('hidden');
            
            recognition.start();

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                recognition.stop();
                callback(transcript);
            };
            recognition.onend = () => {
                listeningIndicator.classList.add('hidden');
            };
            recognition.onerror = (event) => {
                listeningIndicator.classList.add('hidden');
                console.error("Erro no reconhecimento de voz:", event.error);
            };
            return recognition;
        }
        voiceInputBtn.addEventListener('click', () => startVoiceRecognition((transcript) => {
            destinationInput.value = transcript;
            fetchAddressSuggestions(transcript);
        }));
        
        // --- ASSISTENTE VIRTUAL E PALAVRA-CHAVE "HELP" ---

        function startWakeWordListener() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return;
            
            wakeWordRecognition = new SpeechRecognition();
            wakeWordRecognition.lang = 'pt-PT';
            wakeWordRecognition.continuous = true;
            wakeWordRecognition.interimResults = true;

            wakeWordRecognition.onresult = (event) => {
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    const transcript = event.results[i][0].transcript.toLowerCase().trim();
                    if (transcript.includes("help") && !assistantState.active && tutorialModal.classList.contains('hidden')) {
                        openAssistant();
                    }
                }
            };
            
            wakeWordRecognition.onerror = (event) => {
                // Erros como 'no-speech' são normais e o 'onend' irá tratar de reiniciar.
                // Apenas logamos para depuração.
                console.warn("Erro no listener da palavra-chave:", event.error);
            };

            wakeWordRecognition.onend = () => {
                // A API de reconhecimento de voz do navegador para automaticamente por várias razões.
                // Esta lógica garante que ele reinicie discretamente para continuar a ouvir a palavra-chave.
                if (!assistantState.active) {
                    setTimeout(() => {
                        try {
                           if (wakeWordRecognition) wakeWordRecognition.start();
                        } catch(e) {
                           console.error("Não foi possível reiniciar o listener da palavra-chave.", e);
                        }
                    }, 100); // Reinício rápido para minimizar a interrupção
                }
            };
            
            try {
                wakeWordRecognition.start();
            } catch(e) {
                console.error("Não foi possível iniciar o listener de palavra-chave.", e)
            }
        }

        function updateAssistantText(text, shouldSpeak, callback) {
            assistantText.textContent = text;
            if (shouldSpeak) {
                speak(text, callback);
            }
        }

        async function handleAssistantDestination(transcript) {
            updateAssistantText(`A procurar por "${transcript}"...`, false);
            const results = await fetchAddressSuggestions(transcript);
            if (results && results.length > 0) {
                assistantState.tempAddress = results[0];
                assistantState.stage = 'confirming_destination';
                const confirmationText = `Encontrei este endereço: ${results[0].display_name}. Está correto? Diga sim ou não.`;
                updateAssistantText(confirmationText, true, () => {
                    startVoiceRecognition(handleAssistantConfirmation);
                });
            } else {
                assistantState.stage = 'listening_destination';
                const notFoundText = "Não consegui encontrar esse endereço. Pode tentar dizer novamente?";
                updateAssistantText(notFoundText, true, () => {
                    startVoiceRecognition(handleAssistantDestination);
                });
            }
        }

        function handleAssistantConfirmation(transcript) {
            const confirmation = transcript.toLowerCase();
            if (confirmation.includes('sim')) {
                updateAssistantText("Ótimo! A traçar a rota para si.", true, () => {
                    const { lat, lon, display_name } = assistantState.tempAddress;
                    state.routeInitiatedByAssistant = true;
                    createRoute(lat, lon, display_name);
                    closeAssistant();
                });
            } else if (confirmation.includes('não')) {
                assistantState.stage = 'listening_destination';
                const tryAgainText = "Peço desculpa. Por favor, diga o destino novamente.";
                updateAssistantText(tryAgainText, true, () => {
                    startVoiceRecognition(handleAssistantDestination);
                });
            } else {
                const invalidText = "Não percebi. Por favor, diga sim ou não.";
                updateAssistantText(invalidText, true, () => {
                    startVoiceRecognition(handleAssistantConfirmation);
                });
            }
        }

        function openAssistant() {
            if (assistantState.active) return;
            
            if (wakeWordRecognition) wakeWordRecognition.stop();
            assistantState.active = true;
            assistantState.stage = 'listening_destination';
            assistantModal.classList.remove('hidden');
            const welcomeText = "Olá! Sou o seu assistente. Para onde gostaria de ir?";
            updateAssistantText(welcomeText, true, () => {
                startVoiceRecognition(handleAssistantDestination);
            });
        }

        function closeAssistant() {
            if (!assistantState.active) return;
            assistantState.active = false;
            assistantState.stage = 'idle';
            assistantState.tempAddress = null;
            assistantModal.classList.add('hidden');
            window.speechSynthesis.cancel();
            startWakeWordListener();
        }

        assistantBtn.addEventListener('click', openAssistant);
        closeAssistantModalBtn.addEventListener('click', closeAssistant);
        
        // --- FUNCIONALIDADE GEMINI ---
        
        describeSurroundingsBtn.addEventListener('click', async () => {
            if (!userLocation) {
                alert("A sua localização ainda não foi encontrada. Por favor, aguarde.");
                return;
            }
            geminiResponseEl.textContent = '';
            geminiLoader.style.display = 'flex';
            geminiModal.classList.remove('hidden');

            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const profileDescription = {
                'none': 'uma pessoa sem deficiência específica',
                'visual': 'uma pessoa com deficiência visual',
                'motor': 'uma pessoa com deficiência motora, possivelmente em cadeira de rodas',
                'daltonism': 'uma pessoa com daltonismo',
            };
            
            const systemPrompt = "Aja como um assistente de navegação acessível. Forneça descrições concisas e úteis do ambiente em português de Portugal, focando nos aspetos práticos de mobilidade e segurança para o tipo de utilizador especificado.";
            const userQuery = `Descreva os arredores próximos à latitude ${userLocation.lat} e longitude ${userLocation.lng}. A descrição deve focar em acessibilidade para ${profileDescription[state.profile] || 'um utilizador'}. Mencione a condição geral dos passeios, a presença de rampas, o quão movimentada a área parece ser, se há muitos cruzamentos, e se existem pontos de referência fáceis de identificar (como uma loja com uma fachada colorida, uma igreja ou um parque).`;

            try {
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    tools: [{ "google_search": {} }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`Erro da API: ${response.statusText}`);

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Não foi possível obter uma descrição.";
                
                geminiLoader.style.display = 'none';
                geminiResponseEl.textContent = text;
                
                if (state.profile === 'visual') speak(text);

            } catch (error) {
                geminiLoader.style.display = 'none';
                geminiResponseEl.textContent = "Ocorreu um erro ao tentar descrever os arredores. Por favor, tente novamente.";
                console.error("Erro na chamada Gemini:", error);
            }
        });

        closeGeminiModalBtn.addEventListener('click', () => {
            geminiModal.classList.add('hidden');
            window.speechSynthesis.cancel();
        });

        // --- LÓGICA DO TUTORIAL ---
        const tutorialSteps = [
            { icon: 'fa-solid fa-hand-sparkles', title: 'Bem-vindo ao Help!', text: 'Este é um guia rápido para o ajudar a começar a usar a aplicação.' },
            { icon: 'fa-solid fa-search-location', title: 'Encontre o seu Destino', text: 'Use a barra de pesquisa no topo para digitar ou dizer para onde quer ir.' },
            { icon: 'fa-solid fa-compass', title: 'Explore os Arredores', text: 'Use os botões flutuantes para se centrar no mapa, obter descrições por IA dos arredores ou encontrar pontos de interesse.' },
            { icon: 'fa-solid fa-headset', title: 'Chame o Assistente', text: 'A qualquer momento, diga "Help" em voz alta ou toque no ícone do assistente para obter ajuda por voz.' },
            { icon: 'fa-solid fa-check-circle', title: 'Está Pronto!', text: 'Boa viagem! Toque em "Concluir" para começar a explorar.' }
        ];
        let currentTutorialStep = 0;

        function showTutorial() {
            currentTutorialStep = 0;
            updateTutorialStep(currentTutorialStep);
            tutorialModal.classList.remove('hidden');
        }

        function updateTutorialStep(step) {
            const content = tutorialSteps[step];
            tutorialContent.innerHTML = `
                <i class="${content.icon} text-blue-600 text-5xl mb-4"></i>
                <h3 class="text-2xl font-bold text-gray-800 mb-2">${content.title}</h3>
                <p class="text-gray-600">${content.text}</p>
            `;
            tutorialStepIndicator.textContent = `${step + 1} / ${tutorialSteps.length}`;
            
            tutorialPrevBtn.classList.toggle('hidden', step === 0);

            if (step === tutorialSteps.length - 1) {
                tutorialNextBtn.textContent = 'Concluir';
            } else {
                tutorialNextBtn.textContent = 'Próximo';
            }
        }

        tutorialNextBtn.addEventListener('click', () => {
            if (currentTutorialStep < tutorialSteps.length - 1) {
                currentTutorialStep++;
                updateTutorialStep(currentTutorialStep);
            } else {
                tutorialModal.classList.add('hidden');
            }
        });

        tutorialPrevBtn.addEventListener('click', () => {
            if (currentTutorialStep > 0) {
                currentTutorialStep--;
                updateTutorialStep(currentTutorialStep);
            }
        });
        
        // --- FUNÇÕES UTILITÁRIAS ---
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }
        
        function formatTime(seconds) {
            if (seconds < 60) return "Menos de 1 min";
            const minutes = Math.round(seconds / 60);
            if (minutes < 60) return `Aprox. ${minutes} min`;
            const hours = Math.floor(minutes / 60);
            const remainingMinutes = minutes % 60;
            return `Aprox. ${hours}h ${remainingMinutes}min`;
        }
        destinationInput.addEventListener('input', () => debounce(() => fetchAddressSuggestions(destinationInput.value), 300));

    </script>
</body>
</html>

